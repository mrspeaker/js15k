var oneBlock=4;var halfBlock=oneBlock/2;function Car(){this.x=0;this.y=0;this.w=30;this.h=50;this.angle=Math.PI;this.vel=0;this.acc=0;this.angVel=0;this.angAcc=0;this.isPlayer=false;this.active=true;var max=10;this.body=[[0,0,max],[0,0,max],[0,0,max],[0,0,max],[0,0,max],[0,0,max]];this.calcBody()}Car.prototype={calcBody:function(tick){if(this.tick===tick){return}this.tick=tick;var a=this.angle;var c=[this.x-oneBlock,this.y-oneBlock];[[-halfBlock,-halfBlock],[+halfBlock,-halfBlock],[-halfBlock,+halfBlock],[+halfBlock,+halfBlock],[-halfBlock,+halfBlock+oneBlock],[+halfBlock,+halfBlock+oneBlock]].map(function(bo,i){var bx=bo[0];var by=bo[1];var rx=bx*Math.cos(a)-by*Math.sin(a);var ry=bx*Math.sin(a)+by*Math.cos(a);var b=this.body[i];b[0]=c[0]+rx+halfBlock;b[1]=c[1]+ry+halfBlock},this)},update:function(dt,keys,tick){var accThrust=.5;var angAccThrust=.009;var drag=.99;var angDrag=.88;if(this.active){if(keys[38]){this.acc+=accThrust}if(keys[40]){this.acc-=accThrust}if(keys[37]){this.angAcc-=angAccThrust}if(keys[39]){this.angAcc+=angAccThrust}}var velo=this.vel+this.acc;this.vel=velo>0?Math.min(velo,3):Math.max(velo,-3);this.acc=0;this.vel*=drag;this.angVel+=this.angAcc;this.angAcc=0;this.angVel*=angDrag;this.angle+=this.angVel;this.x+=Math.cos(this.angle-Math.PI/2)*this.vel;this.y+=Math.sin(this.angle-Math.PI/2)*this.vel;this.calcBody(tick);if(this.x<0){this.x+=5;this.angle-=Math.PI}if(this.y<0){this.y+=5;this.angle-=Math.PI}if(this.x>640){this.y-=5;this.angle-=Math.PI}if(this.y>300){this.y-=5;this.angle-=Math.PI}},explode:function(){this.active=false},render:function(ctx){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);ctx.fillStyle="#777";ctx.fillRect(-oneBlock,-oneBlock,oneBlock*2,oneBlock*3);ctx.restore();this.active&&this.body.forEach(function(p,i){var row=i/2|0;var col=i%2;var op=row===0?60:row===2?50:30;ctx.fillStyle=this.isPlayer?"hsl(150,50%,"+op+"%)":"hsl(20,50%,"+op+"%)";ctx.fillRect(this.body[i][0],this.body[i][1],oneBlock,oneBlock)},this)},press:function(){if(this.vel>.1){this.angle+=Math.PI}else{this.acc=3}}};function Game(){this.cars=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1].map(function(){return new Car}).map(function(c,i){if(i===0){return c}c.x=Math.cos(i/3)*120+300;c.y=Math.sin(i/3)*80+150;return c})}Game.prototype={update:function(dt,keys,tick){this.cars.forEach(function(c1,i){c1.update(dt,i===0?keys:{},tick);c1.isPlayer=i===0;this.cars.forEach(function(c2){if(c2===c1){return}var dx=c1.x-c2.x;var dy=c1.y-c2.y;if(dy*dy+dx*dx<800){this.check(c1,c2)}},this)},this);if(Math.random()<.01){}},render:function(c){c.clearRect(0,0,c.w,c.h);this.cars.forEach(function(car){car.render(c)})},check:function(c1,c2){for(var i=0;i<6;i++){var b1=c1.body[i];for(var j=0;j<6;j++){var b2=c2.body[j];var dx=b1[0]-b2[0];var dy=b1[1]-b2[1];if(Math.sqrt(dx*dx+dy*dy)<4){b2[2]-=1;c2.acc=Math.random()*20-10;c2.angAcc+=(Math.random()-.5)*.5;c2.angle+=Math.PI*2;if(j/2|0===2&&b2[2]<0){c2.explode()}}}}},press:function(e){this.cars.forEach(function(c){const dist=16;if(Math.abs(e.clientX-c.x)<dist&&Math.abs(e.clientY-c.y)<dist){c.press()}})}};var main={init:function(){this.game=new Game;var c=document.querySelector("#canvas");var ctx=this.ctx=c.getContext("2d");ctx.w=c.width;ctx.h=c.height;var keys={};document.addEventListener("keydown",function(e){keys[e.which]=true},false);document.addEventListener("keyup",function(e){keys[e.which]=false},false);var self=this;document.addEventListener("mousedown",function(e){self.game.press(e)},false);this.keys=keys;this.tick=0;this.run=this.run.bind(this);this.run()},run:function(t){this.game.update(1e3/60,this.keys,this.tick++);this.game.render(this.ctx);requestAnimationFrame(this.run)}};main.init();